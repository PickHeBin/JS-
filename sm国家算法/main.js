/*
头部
x-tif-signature
X-Tingyun

表单加密
signData
encData

响应加密
encData
signData
 */
const CryptoJs = require('crypto-js')
let xl = require('./webout');
//扣算法
window = global


r = xl('68b2')
o = r.sm2
s = r.sm4

function header_js() {
    r = CryptoJs.SHA256
    s = Math.ceil((new Date).getTime() / 1e3)
    h = i()
    f = s + h + s
    nonce = h
    signature = r(f).toString()
    timestamp_ = s
    nonce = h
    Zi = (
        function () {
            function t(t) {
                return 0 > t ? NaN : 30 >= t ? 0 | Math.random() * (1 << t) : 53 >= t ? (0 | Math.random() * (1 << 30)) + (0 | Math.random() * (1 << t - 30)) * (1 << 30) : NaN
            }

            function e(t, e) {
                for (var n = t.toString(16), r = e - n.length, a = "0"; r > 0; r >>>= 1,
                    a += a)
                    1 & r && (n = a + n);
                return n
            }

            return function (n) {
                return n || (n = ""),
                e(t(32), 8) + n + e(t(16), 4) + n + e(16384 | t(12), 4) + n + e(32768 | t(14), 4) + n + e(t(48), 12)
            }
        }());

    function Ir() {
        try {
            return Zi().substring(0, 16)
        } catch (t) {
        }
    }

    Tingyun = "c=B|" + "4Nl_NnGbjwY" + ";x=" + Ir()
    return [signature, nonce, timestamp_, Tingyun]
}

function y(e, t) {

    return A(b(A(e.substr(0, 16)), A(t)).toUpperCase().substr(0, 16))
}

function p(e) {
    var t = new Array
        , n = 0;
    for (var i in e)
        t[n] = i,
            n++;
    var r = [].concat(t).sort()
        , o = {};
    for (var a in r)
        o[r[a]] = e[r[a]];
    return o
}

function v(e) {
    var t = [];
    for (var n in e)
        if (e.hasOwnProperty(n) && (e[n] || "".concat(e[n])))
            if ("data" === n) {
                var i = Object.assign({}, e[n]);
                for (var r in i) {
                    if ("number" != typeof i[r] && "boolean" != typeof i[r] || (i[r] = "" + i[r]),
                    Array.isArray(i[r]) && !i[r].length && delete i[r],
                    Array.isArray(i[r]) && i[r].length > 0)
                        for (var o = 0; o < i[r].length; o++)
                            i[r][o] = p(i[r][o]);
                    null != i[r] && i[r] || delete i[r]
                }
                var a = p(i);
                t.push("".concat(n, "=").concat(JSON.stringify(a)))
            } else
                t.push("".concat(n, "=").concat(e[n]));
    c = data['appSecret']
    return t.push("key=".concat(c)),
        t.join("&")
}

function A(e) {
    var t, n, i = new Array;
    t = e.length;
    for (var r = 0; r < t; r++)
        (n = e.charCodeAt(r)) >= 65536 && n <= 1114111 ? (i.push(n >> 18 & 7 | 240),
            i.push(n >> 12 & 63 | 128),
            i.push(n >> 6 & 63 | 128),
            i.push(63 & n | 128)) : n >= 2048 && n <= 65535 ? (i.push(n >> 12 & 15 | 224),
            i.push(n >> 6 & 63 | 128),
            i.push(63 & n | 128)) : n >= 128 && n <= 2047 ? (i.push(n >> 6 & 31 | 192),
            i.push(63 & n | 128)) : i.push(255 & n);
    return i
}

function b(t, n) {
    var i = 16 - parseInt(n.length % 16);
    n = n.concat(new Array(i).fill(i));

    var r = s.encrypt(n, t);
    return new Buffer.from(r).toString("hex")
}


function data_js(_data) {
    data = {
        appCode: "T98HPCGN5ZVVQBS8LZQNOAEXVI9GYHKQ",
        version: "1.0.0",
        appSecret: "NMVFVILMKT13GEMD3BKPKCTBOQBPZR2P",
        publicKey: "BEKaw3Qtc31LG/hTPHFPlriKuAn/nzTWl8LiRxLw4iQiSUIyuglptFxNkdCiNXcXvkqTH79Rh/A2sEFU6hjeK3k=",
        privateKey: "AJxKNdmspMaPGj+onJNoQ0cgWk2E3CYFWKBJhpcJrAtC",
        publicKeyType: "base64",
        privateKeyType: "base64"
    }
    t = {}
    t.data = _data

    function m(e) {
        var t = {}
            , n = ["signData", "encData", "extra"];
        for (var i in e)
            e.hasOwnProperty(i) && !n.includes(i) && null != e[i] && (t[i] = e[i]);
        return t
    }


    signData = function (t) {

        var n = m(t.data)
            , i = p(n);
        i.data = p(i.data);
        d = '009c4a35d9aca4c68f1a3fa89c93684347205a4d84dc260558a049869709ac0b42'
        var r = v(i)
            , a = o.doSignature(r, d, {
            hash: !0
        });
        return new Buffer.from(a, "hex").toString("base64")
    }(t)
    console.log(signData)


    encData = function (e, t) {
        switch (e.toUpperCase()) {
            case "SM2":
                return function (e) {
                    try {
                        var t = o.generateKeyPairHex()
                            , n = t.publicKey
                            , i = e;
                        o.doEncrypt(i, n, 1)
                    } catch (e) {
                    }
                }(t);
            case "SM3":
                return function (e) {
                    try {
                        var t = a(e);
                        return t
                    } catch (e) {
                    }
                }(t);
            case "SM4":
                return function (e) {
                    try {
                        var t = e.data.data && JSON.stringify(e.data.data)
                            , n = A(t);
                        u = data['appCode']
                        e.data.appCode && e.data.appCode !== u && (u = e.data.appCode);

                        var i = y(u, c)
                            , r = b(i, n);
                        return r.toUpperCase()
                    } catch (e) {
                        console.log(e);
                    }
                }(t)
        }
    }("SM4", t)
    return [signData, encData]
}

//响应 encData
function response_js(response) {
    encData = function g(t, n) {
        switch (t.toUpperCase()) {
            case "SM4":
                return function (t) {
                    if (!t)
                        return null;
                    var n = new Buffer.from(t.data.data.encData, "hex")
                        , i = function (t, n) {
                        var i = s.decrypt(n, t)
                            , r = i[i.length - 1];
                        return i = i.slice(0, i.length - r),
                            new Buffer.from(i).toString("utf-8")
                    }(y('T98HPCGN5ZVVQBS8LZQNOAEXVI9GYHKQ', 'NMVFVILMKT13GEMD3BKPKCTBOQBPZR2P'), n);
                    return JSON.parse(i)
                }(n);
            case "SM2":
                return function (e) {
                    try {
                        var t = o.generateKeyPairHex()
                            , n = t.privateKey;
                        o.doDecrypt(encryptData, n, 1)
                    } catch (e) {
                    }
                }()
        }
    }("SM4", response)
    return encData
}

// response_js()
//响应 signData
response = {
    'code': 0, 'data': {
        'signData': 'WDa5QssmxZx+erRYYCDP8BM1q4wCxtmKsNQhpmkC/emDR+ocW0qOeIpViiIAI8/UPxyFo2pNS8Yffh/AlSDUyw==',
        'encType': 'SM4',
        'data': {'encData': '1BA85A41FFE8BE3C096DBED625AF99E57FF0FAC4DF382887CE7C00745C55A0ED4B63A7F77235A5A7194CD448FBE4C0C8BF3D426429A7187D08CDA5638DA316CFB8B550BDF057DC0BD6D9CFB0898C8799347980AA2B80F9A8DFD3ED9F8AC908A8E26AE3254AF72EAAA22D21154C30282BA42CDA1D684CEB0126999A8A45177C9DEE627184ACEB4A5AB69F4974DADE910E7F9F8A44AAA22D221CF1A05B89601E6CA0CD4364B26C5E07FE25ACF4A994B27686A7A2855A90A6334A00B9AAE01723173730103C75736637E927229BA66D8CA8546875E24E676858EDCF4F076ABA1AD413C56271D15DCF9ECFDAC0BC713592002BC6BE5D9B247B376C1A0D37F51756273F0D68961536BBE4B1218D3A1211D72837DFF9561940199DEBAFD54293861DD4B4F51A3B07DF7526FEAF3DC7001EF60387056E641E4FC48A95148E2FF83DD8ED4B14BC98C81A785D20C84EE32F36CECC57D71245D5F47307AD67C8AE9557D6A2EDFD2771DE1F24865752A9B0C0592DBF220F1D296E4E81EBA626FE0523D6EF78BBEA0FCDAC8346D836601F8E0993F47A0AE945942B8AB1D65536B983CA17FF10C2B59F26D61BEF30CAA7058DEF8ED2BE772EF9455A3A9A28929849E475199E7E8C061A83BE8A5BA89EEA3D2CB66EC4099F550BF280382A72A5C100BBD2C15A3E0ABF7768CB2665A5D943892A63F2B2CD8B64A62F323C51129CD67847C4310D7C62A55121B65ACA4B29423A7AC838AC3805DF5B61CF06DB84FC4E7189F7D4A394CBF7847FB40B43E36CBB2BA1137D70B6AD9BD43BDEAEB91AE67C84C37B9BFE9F02B69418ED40B313C30136304291A11EA7F6533CC68ABD3EC109AC65EFB7202FB4F51A3B07DF7526FEAF3DC7001EF60387056E641E4FC48A95148E2FF83DD8ED4B14BC98C81A785D20C84EE32F36CECC57D71245D5F47307AD67C8AE9557D6A2EDFD2771DE1F24865752A9B0C0592DBF0E6CF3C6AF8FE2F39EA1DEEED4DE69A0187AB6C36A36CDB437D470EA728397870AE945942B8AB1D65536B983CA17FF10C2B59F26D61BEF30CAA7058DEF8ED2BE1A122198A6921FE423CD5356E558540EF2F836EA57FAF8AB6ED7A386C306A531739D5EC8A8E57BFDB2E1743D417C71CB21EEFF8195593634B305532B85E145AFE0EA58114DBDF74572451C3279681405F05AC350C31BB4856DD758FEAA72C5A5921CA472777CA93A333D33AB16390F7A54DA5A294D55E476AE332ECDC6642D4414109F236937F26B68594842F6E41E23F6EC06D6CC9DB97F3DF39250A207D611D5DD7626BAE59AA43045B00126FDA9AF95F48483063CB643BC7E59B164C9E02CBBF3A512C994A696B273A7CCE0B6D7C1C3767CB9A068F9DBDD2BEB65E50241F9C6B462EB18D44C4C2A9C5EAFF01D8010FC44A46D3B19929B3B75EF74A7252EEF0A7D974F128FFA30EB4BD4357AB5CCD83D8433624889261F57716CC266D83C87FB42142A279274B911A722FF7B46BD282115D0AAE9D7B7D78CEDC25EC75C590F95543525D78286EE50E4104CDFE764E3F3F65EEB6022642BAFBB551407A00B5E10D0F4FFE0DDFF36C88076F7030376D88BD57B66B08C9517688C11CB77E0FFDA06448D03B078DA7BCA43BE90BC83CCF87362EB0B766B1367160A87B21E409DA76D98C0B79EE01973B10C880F9E424848FA551A2ED1036359FC0EBBC22C74FB5935DD95DD8AA85307D8C9F4B545263AF3F4AA9E2F9872B3A620989F48E008F6BFC87E9872BD3DBA6B638E31572275CE0833A2004D4DF68F89A16D6AA87BC1B97FA04F36CD93C719DDD0B296DDB3A7861F738DC3C0CF4DC8C96FC516DD882ED5EFEB7ADF4F6DFE33B944A1F6D6700030D8316DF391FBBC8E034DA973E3DA899F917C37C9BB213CA62787AEFFED34814628969F3ABB11E8773827AD7FC2C75C4F1DAC134E8188C2F44B98A32205AB42FA1865A120EF3989E8C6FF6004A8BAA0A8B4FC9BBCF2D2DE89A4074EE4BBA97E10169ADED30DB4E14ED711527DA8270B6C090877B52CE825AC06546E9D080AE31EF194DE6DED277619482783658BB60A151A11ACCE42C02FC7C7830B8BED3B0E5CF56BCD475E929370106A3FB2B86B53E15349E3ECF7F89C1E82533991F33726C9FAAAAC391D5678B1585890137910C8F1E1468FD4E50D8A32C84E0BE9BF58620A4FDC764432E3FBE90FCD67C76AB8B360BA03DBEC9C591C3CD265AB18F48AD772B1C216B72BDAE176DB9C5EA1DC15213566C9F7B2B9AAAB042A68AFCB2A68C5C76EB38E4B9D74DEA64EDF1F13E8A9D5B98774A168EBAE3E37676A5E9C507A3991E49A72D11B42B012A3FECD2F6F25A290F95F2CCC1A278686EF7A7CDD517D0E6291ECD19180E682730837DB149C8C9E283C22D53E45DF95D43E7BA3415163B98F075AD106D50C77C515D751A413AB7375AF521CED5CE61818F88089CBAD04B1DD30B3056A261A5695496300B7FCE16FD6C85C5D0DBC7B72B587E020F219230B4324E413ECA217A051B44A8DD345D2A481E38153D721EB8C9BACF41632909659876576B6C038FDD2A73CF840C7C7DF23163D83370103780CE14CE293880959843EADE172EFE829C71B6900955989F9C6F70FECD596E829D90786EC786CA380F01373546F50FE2A9736DA3995C52A6FDD6B31125D2BAF7EC97AD747C3977062F3E80CDEB436F3597CD5045CF418DC13EE684A31470D68934E10610E52D3D0D51E2273C496E70618C67B5CCDA1C563384A1136282A56E3FABB13D5FF64933D85663401B004E462B1AC835F03A779BE611D9708D8E039DC12DBE649FC5F5FE7D80A6C4476E879408E15E765126EABE295D15534BCA48EA24B2F29450BCB7BD50F029390FF05AAACC321250E30F2C1E52F2FB440952DAFD017D3316E510E50E0A051A7EB79C549F06F37FF257E4AAC3EF69152DD7841004B6FEE50D2B9FE2494A3A1DFAF14A6018C096EB8A221891C7BE684F355B50A73E984228C2FFAA827291E64629175DCBFDDB1C69B7EDE1B47173A03104B6985E4B417FAC7B9628CF551B2B89F396C12D33360AB4A98CC1BD5EB45E27CF281EAD3E7BC34C027D599FDAF42120A32779D3BDD9AB34E56DEE9FBA49C8B75C5BA672C9835F024C78CAC5F3FD83FAA6E4C2873D27263E6AF4A9D1156FCD734BC451B5D80DAB422BFEF26980E86C77E5BD23284B6C5F17D76EF336F8D52D40841ED0207009917E569F0FE58C76F9C3DFD9F868D6A692C323E4E8FBC262776651B13032C7DF63D4009B01CD600BF3B9887061920599982B556ABCBB7342E60FB85A348577D11DD649CBF4A443A6274B390E13453881245615C917D409D2D01E95997BA49C801FEE82A7F3F06B0F388B62A4162F004791BA467255E5681D8B3742BFDAB509CE5C10DB60B44C94C6C982EFE741323AB3B952AED8C450AE354536A566CB46881D3EB280C4F285B9FBA06D66B6D98C0B79EE01973B10C880F9E424848E2E8FDB6F5BF6E33DAFA43EE31DB7D5A5CB992209A8BD351896E6CE818B8C560F4AA9E2F9872B3A620989F48E008F6BF3B510BA759B507283435077D5E9509044E5640959101743EA8DEAE824B0504B90BC304CB95224AA607B7B6DB65419F76738DC3C0CF4DC8C96FC516DD882ED5EFEB7ADF4F6DFE33B944A1F6D6700030D8316DF391FBBC8E034DA973E3DA899F913C5FDA7C37D7106A51B98E39393CBA6108A419F576025F998DB9DD7B0A2461C0C68D13A27456A88330126975979188FDAD7A5E8318E4B802A32335916CD776D7BA3984F7CB7C38EF296B43DDC616BBF3DA7215575DDF107413D2CF0F6B12EC504BAD3AC8EE69B734C278AFC03D13E69B8A84907567247A90562A38467FD2292B428E4A2D0990A0C3F3472DA602C63947223FC9717B8EE2835170FBCFAF6FF536B1CD7D834A8787F595A44F610E3CA9E3D97BB5C4C7AD967CC985371A435B5D80CAA1D298B5AE65DA19D47DCB80FA86F6D51019CD988FA47B44156550F5F4E38207E1944358295A0A9CB76B28E7BCEA70314FE8C94681A1498F6DB9D0A020B67C382110B719EA64AF0B9FFEDD0610133D74AB6B8673EE3D98502FC844D3258DFC129E5149F87D797291136B7BDD33082080B13FF757BB750F7E78732B26EA973793A178569B4E39BB1110CDCD5D6CDA1F98699462315241502A707B9CBA4958F01235ABD76E24CC70D56C4EB7B6C22A74FC9BBCF2D2DE89A4074EE4BBA97E1016FC796062BCA0A49552D26E334B247E0B409E6390C1B3D6C81899EECCBF78194E0C9A01E20B6404E02C5DAE578FE1D963A0CD4364B26C5E07FE25ACF4A994B276DB265F0600444CE296AF8A544E8327A8A3525236B2214A8A4EAB2CF4A0635B410C7D41684710070ABB531B972019175F7207B48A446C98D5E7708CFA676307571D1EA4513D321825C58216249069B8CE3F0D68961536BBE4B1218D3A1211D72853009AD23DDDAE738936B215F367950D4CE061D7555276A5D7AB89D289D13C9787056E641E4FC48A95148E2FF83DD8ED59C4E58716FBAE4CACE48FEEFE22CE76083A140D0DBE14F4FA8895693EC3499957EF5554E70DF20419FB905BF6F98DDA8B6D69FBA010BD1B4DCBB43DFA2D3DFA2AC93AFB855ACAB9A701340CB3278094B0C4FF41D948E6415F420165443E34CD7D8435348CC594A7B221F13BF85E52EA56CD1D7B0EAC2627586E5717014DCE9F25B12F5DC7ECE8BA990FD2DCA07174748E7594BEC9C88A33784F1F2BE0819A127016234B5FF6C92E5D087B557817C029CA262CC3E0BDAF3D7646C8885D9EC816899D5837E7F68DB5AE37E71DB74A1EDC59B8B7FF0B2600665F9CB4CB6263FDCEBB6674C23A7DBA8541EEE042745B173611B61C82D4C7472F3227921593EBC513A944B91B1D804655159E59AA879751AD64E17F6D034CF0FBC746F3F031407CC98FD4F81FFB08ABB280F9810BAB03E40C034A1BE63EE79D6E1887EFDB6661558B3120D8E215EBA81E1852F650F583044C'},
        'signType': 'SM2',
        'appCode': 'T98HPCGN5ZVVQBS8LZQNOAEXVI9GYHKQ',
        'version': '1.0.0',
        'timestamp': '1683817236019'
    }, 'message': '成功', 'timestamp': '1683817236', 'type': 'success'
}

console.log(response_js(response))

// console.log(header_js())